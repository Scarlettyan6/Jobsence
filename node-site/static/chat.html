<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>AI Chat Assistant</title>
    <script src="./assets/js/marked.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: #f8f9fa;
            height: 100vh;
            overflow: hidden;
        }

        .chat-container {
            display: flex;
            height: 100vh;
        }

        /* å·¦ä¾§å†å²è®°å½•æ  */
        .sidebar {
            width: 280px;
            background: #ffffff;
            border-right: 1px solid #e5e7eb;
            display: flex;
            flex-direction: column;
        }

        .sidebar-header {
            padding: 20px;
            border-bottom: 1px solid #e5e7eb;
        }

        .new-chat-btn {
            width: 100%;
            padding: 12px 16px;
            background: #2563eb;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: background 0.2s;
        }

        .new-chat-btn:hover {
            background: #1d4ed8;
        }

        .model-selector {
            margin-top: 12px;
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            background: white;
            font-size: 14px;
        }

        .chat-history {
            flex: 1;
            overflow-y: auto;
            padding: 16px;
        }

        /* å†å²è®°å½•åˆ†ç»„æ ·å¼ */
        .history-group {
            margin-bottom: 16px;
        }

        .group-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 12px;
            background: #f8f9fa;
            border-radius: 6px;
            margin-bottom: 8px;
            cursor: pointer;
            transition: background 0.2s;
            user-select: none;
        }

        .group-header:hover {
            background: #e9ecef;
        }

        .group-title {
            font-size: 13px;
            font-weight: 600;
            color: #495057;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .group-count {
            font-size: 12px;
            color: #6c757d;
            background: #dee2e6;
            padding: 2px 6px;
            border-radius: 10px;
            min-width: 18px;
            text-align: center;
        }

        .group-items {
            padding-left: 8px;
            transition: all 0.3s ease;
        }

        .history-group.collapsed .group-items {
            display: none;
        }

        .group-header.collapsed::after {
            content: 'â–¶';
            font-size: 10px;
            color: #6c757d;
            margin-left: auto;
        }

        .group-header:not(.collapsed)::after {
            content: 'â–¼';
            font-size: 10px;
            color: #6c757d;
            margin-left: auto;
        }

        /* å†å²è®°å½•é¡¹å¸ƒå±€è°ƒæ•´ */
        .history-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 8px 12px;
            margin: 2px 0;
            border-radius: 6px;
            cursor: pointer;
            transition: background-color 0.2s;
            position: relative;
        }

        .history-content {
            flex: 1;
            min-width: 0; /* å…è®¸æ–‡æœ¬æˆªæ–­ */
        }

        .history-item:hover {
            background-color: #f5f5f5;
        }

        .history-item.active {
            background-color: #e3f2fd;
        }

        /* åˆ é™¤æŒ‰é’®æ ·å¼ */
        .delete-chat-btn {
            background: none;
            border: none;
            color: #666;
            cursor: pointer;
            padding: 4px;
            border-radius: 4px;
            opacity: 0;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-left: 8px;
            flex-shrink: 0;
        }
        /* ... existing styles ... */

        /* PDFæå–ç›¸å…³æ ·å¼ */
        .pdf-extraction-success {
            animation: slideIn 0.3s ease-out;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* è¾“å…¥æ¡†ç¦ç”¨çŠ¶æ€æ ·å¼ */
        .message-input:disabled {
            background-color: #f5f5f5;
            cursor: not-allowed;
            opacity: 0.7;
        }

        /* ... existing styles ... */
        .history-item:hover .delete-chat-btn {
            opacity: 1;
        }

        .delete-chat-btn:hover {
            background-color: #ffebee;
            color: #d32f2f;
        }

        .delete-chat-btn svg {
            width: 14px;
            height: 14px;
        }

        .history-title {
            font-size: 13px;
            font-weight: 500;
            color: #212529;
            margin-bottom: 4px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            line-height: 1.3;
        }

        .history-time {
            font-size: 11px;
            color: #6c757d;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .history-time::before {
            content: 'ğŸ•’';
            font-size: 10px;
        }

        /* ç©ºçŠ¶æ€æ ·å¼ */
        .empty-group {
            text-align: center;
            padding: 20px;
            color: #6c757d;
            font-size: 13px;
            font-style: italic;
        }

        /* æ»šåŠ¨æ¡ç¾åŒ– */
        .chat-history::-webkit-scrollbar {
            width: 6px;
        }

        .chat-history::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 3px;
        }

        .chat-history::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 3px;
        }

        .chat-history::-webkit-scrollbar-thumb:hover {
            background: #a8a8a8;
        }

        /* ä¸»èŠå¤©åŒºåŸŸ */
        .main-chat {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: white;
        }

        .chat-header {
            padding: 20px 24px;
            border-bottom: 1px solid #e5e7eb;
            background: white;
        }

        .chat-title {
            font-size: 18px;
            font-weight: 600;
            color: #111827;
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 24px;
            background: #f8f9fa;
        }

        /* æ¶ˆæ¯å®¹å™¨ - åŸºç¡€å¸ƒå±€ */
        .message {
            margin-bottom: 24px;
            display: flex;
            gap: 12px;
            width: 100%;
        }

        /* ç”¨æˆ·æ¶ˆæ¯ - å³å¯¹é½ */
        .message.user {
            flex-direction: row-reverse;
            justify-content: flex-start; /* ç¡®ä¿å³å¯¹é½ */
        }

        /* AIåŠ©æ‰‹æ¶ˆæ¯ - å·¦å¯¹é½ */
        .message.assistant {
            justify-content: flex-start; /* ç¡®ä¿å·¦å¯¹é½ */
        }

        .message-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            font-weight: 600;
            flex-shrink: 0;
        }

        .message.user .message-avatar {
            background: #2563eb;
            color: white;
        }

        .message.assistant .message-avatar {
            background: #10b981;
            color: white;
        }

        /* æ¶ˆæ¯å†…å®¹å®¹å™¨ - å…³é”®çš„è‡ªé€‚åº”è®¾ç½® */
        .message-content {
            display: flex;
            flex-direction: column;
            /* ç§»é™¤å›ºå®šçš„max-widthï¼Œæ”¹ä¸ºåŠ¨æ€è®¡ç®— */
            min-width: 0; /* å…è®¸æ”¶ç¼© */
            max-width: calc(100% - 44px); /* å‡å»å¤´åƒå®½åº¦å’Œé—´è· */
            width: fit-content; /* æ ¹æ®å†…å®¹è‡ªé€‚åº”å®½åº¦ */
            position: relative; /* ä¸ºæ“ä½œæŒ‰é’®å®šä½ */
        }

        /* ç”¨æˆ·æ¶ˆæ¯å†…å®¹ - å³å¯¹é½ä¼˜åŒ– */
        .message.user .message-content {
            align-items: flex-end; /* æ°”æ³¡å³å¯¹é½ */
            max-width: min(70%, 500px); /* ç”¨æˆ·æ¶ˆæ¯é€šå¸¸è¾ƒçŸ­ */
        }

        /* AIåŠ©æ‰‹æ¶ˆæ¯å†…å®¹ - å·¦å¯¹é½ä¼˜åŒ– */
        .message.assistant .message-content {
            align-items: flex-start; /* æ°”æ³¡å·¦å¯¹é½ */
            max-width: min(80%, 700px); /* AIå›å¤å¯èƒ½è¾ƒé•¿ */
        }

        /* æ°”æ³¡æ ·å¼ - å®Œå…¨è‡ªé€‚åº” */
        .message-bubble {
            /* åŠ¨æ€å†…è¾¹è·ï¼Œæ ¹æ®å†…å®¹è°ƒæ•´ */
            padding: clamp(6px, 12vw, 14px) clamp(8px, 22vw, 24px);
            border-radius: clamp(12px, 2vw, 16px);
            line-height: 1.4;
            font-size: clamp(13px, 2vw, 14px);
            
            /* å…³é”®ï¼šè®©æ°”æ³¡æ ¹æ®å†…å®¹è‡ªé€‚åº” */
            width: fit-content; /* æ ¹æ®å†…å®¹è‡ªé€‚åº”å®½åº¦ */
            min-width: 20px; /* æœ€å°å®½åº¦ï¼Œé¿å…è¿‡å° */
            max-width: 100%; /* ç»§æ‰¿çˆ¶å®¹å™¨é™åˆ¶ */
            
            /* æ–‡æœ¬æ¢è¡Œå¤„ç† */
            word-wrap: break-word;
            word-break: break-word;
            white-space: pre-wrap; /* ä¿æŒæ¢è¡Œå’Œç©ºæ ¼ */
            
            /* å¹³æ»‘è¿‡æ¸¡æ•ˆæœ */
            transition: all 0.2s ease;
            
            /* ç¡®ä¿å†…å®¹ä¸ä¼šæº¢å‡º */
            overflow-wrap: break-word;
            hyphens: auto;
        }


        /* ç”¨æˆ·æ¶ˆæ¯æ°”æ³¡ - å³å¯¹é½æ ·å¼ */
        .message.user .message-bubble {
            background: #d6e1f7;
            color: rgb(94, 93, 93);
            white-space: unset;
            padding: clamp(6px, 12vw, 14px) clamp(8px, 22vw, 24px);
            /* çŸ­æ¶ˆæ¯ä¼˜åŒ– */
            max-width: min(400px, 70vw);
        }

        /* AIåŠ©æ‰‹æ¶ˆæ¯æ°”æ³¡ - å·¦å¯¹é½æ ·å¼ */
        .message.assistant .message-bubble {
            background: white;
            color: #374151;
            border: 1px solid #e5e7eb;
            white-space: unset;
            padding: clamp(6px, 12vw, 14px) clamp(8px, 22vw, 24px);
            
            /* é•¿æ¶ˆæ¯ä¼˜åŒ– */
            max-width: min(600px, 80vw);
        }

        /* é’ˆå¯¹ä¸åŒå†…å®¹é•¿åº¦çš„æ™ºèƒ½è°ƒæ•´ */
        .message-bubble:has(pre), 
        .message-bubble:has(code) {
            /* ä»£ç å—éœ€è¦æ›´å¤šç©ºé—´ */
            max-width: min(90%, 800px) !important;
            font-family: 'Monaco', 'Menlo', monospace;
        }

        /* çŸ­æ¶ˆæ¯ä¼˜åŒ–ï¼ˆå•è¡Œæ–‡æœ¬ï¼‰ */
        .message-bubble:not(:has(br)):not(:has(p)):not(:has(pre)):not(:has(code)) {
            /* å•è¡ŒçŸ­æ¶ˆæ¯ï¼Œæ›´ç´§å‡‘çš„æ ·å¼ */
            padding: clamp(6px, 0.4vw, 8px) clamp(10px, 2vw, 12px);
            min-width: 30px;
        }

        /* é•¿æ¶ˆæ¯ä¼˜åŒ– */
        .message-bubble:has(p), 
        .message-bubble:has(br) {
            /* å¤šè¡Œæ¶ˆæ¯ï¼Œæ›´å®½æ¾çš„å†…è¾¹è· */
            padding: clamp(10px, 12vw, 14px) clamp(14px, 14vw, 18px);
        }

        .message-bubble code {
            background: rgba(232, 237, 247, 0.1);
            padding: 2px 6px;
            border-radius: 4px;
            font-family: 'Monaco', 'Menlo', monospace;
        }

        .message.assistant .message-bubble code {
            background: #f3f4f6;
        }

        .message-bubble pre {
            background: rgba(0, 0, 0, 0.1);
            padding: 12px;
            border-radius: 8px;
            overflow-x: auto;
            margin: 8px 0;
        }

        .message.assistant .message-bubble pre {
            background: #f8f9fa;
        }

        /* è¾“å…¥åŒºåŸŸ */
        .input-area {
            padding: 24px;
            background: white;
            border-top: 1px solid #e5e7eb;
        }

        .input-container {
            position: relative;
            max-width: 800px;
            margin: 0 auto;
        }

        .input-wrapper {
            display: flex;
            align-items: flex-end;
            background: white;
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            padding: 12px;
            transition: border-color 0.2s;
        }

        .input-wrapper:focus-within {
            border-color: #2563eb;
        }

        .file-upload {
            margin-right: 8px;
        }

        .file-upload input {
            display: none;
        }

        .file-upload-btn {
            width: 36px;
            height: 36px;
            border: none;
            background: #f3f4f6;
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.2s;
        }

        .file-upload-btn:hover {
            background: #e5e7eb;
        }

        .message-input {
            flex: 1;
            border: none;
            outline: none;
            resize: none;
            font-size: 14px;
            line-height: 1.5;
            max-height: 120px;
            min-height: 20px;
            font-family: inherit;
        }

        .send-btn {
            width: 36px;
            height: 36px;
            border: none;
            background: #2563eb;
            color: white;
            border-radius: 8px;
            cursor: pointer;
            margin-left: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.2s;
        }

        .send-btn:hover {
            background: #1d4ed8;
        }

        .send-btn:disabled {
            background: #9ca3af;
            cursor: not-allowed;
        }

        .uploaded-files {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 8px;
        }

        .uploaded-file {
            display: flex;
            align-items: center;
            gap: 6px;
            background: #f3f4f6;
            padding: 6px 10px;
            border-radius: 6px;
            font-size: 12px;
            color: #374151;
        }

        .remove-file {
            background: none;
            border: none;
            color: #6b7280;
            cursor: pointer;
            padding: 0;
            width: 16px;
            height: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .typing-indicator {
            display: none;
            align-items: center;
            gap: 8px;
            color: #6b7280;
            font-size: 14px;
            margin-bottom: 16px;
        }

        .typing-dots {
            display: flex;
            gap: 4px;
        }

        .typing-dot {
            width: 6px;
            height: 6px;
            background: #6b7280;
            border-radius: 50%;
            animation: typing 1.4s infinite;
        }

        .typing-dot:nth-child(2) {
            animation-delay: 0.2s;
        }

        .typing-dot:nth-child(3) {
            animation-delay: 0.4s;
        }

        @keyframes typing {
            0%, 60%, 100% {
                opacity: 0.3;
            }
            30% {
                opacity: 1;
            }
        }

        /* æœç´¢å’Œæ€è€ƒçŠ¶æ€çš„æ ·å¼ */
        .search-status, .thinking-status {
            display: flex;
            align-items: center;
            gap: 8px;
            color: #6b7280;
            font-size: 14px;
        }
        
        .search-icon {
            font-size: 16px;
        }
        
        .loading-spinner {
            width: 16px;
            height: 16px;
            border: 2px solid #e5e7eb;
            border-top: 2px solid #2563eb;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* AIåŠ è½½åŠ¨ç”»æ ·å¼ */
        .ai-loading {
            display: flex;
            align-items: center;
            gap: 8px;
            color: #6b7280;
            font-size: 14px;
        }
        
        .ai-loading-dots {
            display: flex;
            gap: 4px;
        }
        
        .ai-loading-dot {
            width: 8px;
            height: 8px;
            background: #10b981;
            border-radius: 50%;
            animation: aiLoading 1.5s infinite;
        }
        
        .ai-loading-dot:nth-child(1) {
            animation-delay: 0s;
        }
        
        .ai-loading-dot:nth-child(2) {
            animation-delay: 0.3s;
        }
        
        .ai-loading-dot:nth-child(3) {
            animation-delay: 0.6s;
        }
        
        @keyframes aiLoading {
            0%, 60%, 100% {
                transform: scale(0.8);
                opacity: 0.5;
            }
            30% {
                transform: scale(1.2);
                opacity: 1;
            }
        }

        /* æ¶ˆæ¯æ“ä½œæŒ‰é’®æ ·å¼ */
        .message-actions {
            display: flex;
            gap: 4px;
            margin-top: 6px;
            opacity: 0;
            transition: opacity 0.2s ease;
            justify-content: flex-start;
        }

        .message.user .message-actions {
            justify-content: flex-end;
        }

        .message:hover .message-actions {
            opacity: 1;
        }

        .action-btn {
            background: rgba(255, 255, 255, 0.9);
            border: 1px solid #e5e7eb;
            border-radius: 6px;
            padding: 6px;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #6b7280;
            backdrop-filter: blur(4px);
        }

        .action-btn:hover {
            background: white;
            color: #374151;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            transform: translateY(-1px);
        }

        .regenerate-btn:hover {
            color: #2563eb;
            border-color: #2563eb;
        }

        .copy-btn:hover {
            color: #10b981;
            border-color: #10b981;
        }

        .delete-btn:hover {
            color: #dc2626;
            border-color: #dc2626;
        }

        /* å¤åˆ¶æˆåŠŸæç¤º */
        .copy-success {
            position: relative;
        }

        .copy-success::after {
            content: 'å·²å¤åˆ¶';
            position: absolute;
            top: -30px;
            left: 50%;
            transform: translateX(-50%);
            background: #374151;
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            white-space: nowrap;
            z-index: 1000;
            animation: fadeInOut 2s ease;
        }

        @keyframes fadeInOut {
            0%, 100% { opacity: 0; }
            20%, 80% { opacity: 1; }
        }

        /* å“åº”å¼è®¾è®¡ */
        @media (max-width: 768px) {
            .sidebar {
                width: 100%;
                position: absolute;
                z-index: 1000;
                transform: translateX(-100%);
                transition: transform 0.3s;
            }

            .sidebar.open {
                transform: translateX(0);
            }

            .main-chat {
                width: 100%;
            }
            
            .message.user .message-content {
                max-width: 80%; /* ç§»åŠ¨ç«¯ç”¨æˆ·æ¶ˆæ¯ */
            }
            
            .message.assistant .message-content {
                max-width: 85%; /* ç§»åŠ¨ç«¯AIæ¶ˆæ¯ */
            }
            
            .message-bubble {
                font-size: 13px;
                padding: 8px 12px;
            }
        }

        @media (max-width: 480px) {
            .message.user .message-content {
                max-width: 85%;
            }
            
            .message.assistant .message-content {
                max-width: 90%;
            }
            
            .message-bubble {
                font-size: 12px;
                padding: 6px 10px;
                border-radius: 12px;
            }
            
            .message {
                gap: 8px; /* ç§»åŠ¨ç«¯å‡å°é—´è· */
            }

            .action-btn {
                padding: 4px;
            }

            .action-btn svg {
                width: 12px;
                height: 12px;
            }
        }
    </style>
</head>
<body>
    <div class="chat-container">
        <!-- å·¦ä¾§å†å²è®°å½•æ  -->
        <div class="sidebar">
            <div class="sidebar-header">
                <button class="new-chat-btn" onclick="startNewChat()">+ æ–°å»ºå¯¹è¯</button>
                <select id="selectLLM" class="model-selector">
                    <option value="chat">å°±ä¸šå’¨è¯¢æ¨¡å‹</option>
                    <option value="chat_reason">é¢è¯•æ¨¡æ‹Ÿæ¨¡å‹</option>
                </select>
            </div>
            <div class="chat-history" id="chatHistory">
                <!-- ä»Šå¤© -->
                <div class="history-group" id="today-group">
                    <div class="group-header" onclick="toggleGroup('today-group')">
                        <span class="group-title">ä»Šå¤©</span>
                        <span class="group-count" id="today-count">0</span>
                    </div>
                    <div class="group-items" id="today-items"></div>
                </div>
                
                <!-- æ˜¨å¤© -->
                <div class="history-group" id="yesterday-group" style="display: none;">
                    <div class="group-header" onclick="toggleGroup('yesterday-group')">
                        <span class="group-title">æ˜¨å¤©</span>
                        <span class="group-count" id="yesterday-count">0</span>
                    </div>
                    <div class="group-items" id="yesterday-items"></div>
                </div>
                
                <!-- ä¸ƒå¤©å†… -->
                <div class="history-group" id="week-group" style="display: none;">
                    <div class="group-header" onclick="toggleGroup('week-group')">
                        <span class="group-title">ä¸ƒå¤©å†…</span>
                        <span class="group-count" id="week-count">0</span>
                    </div>
                    <div class="group-items" id="week-items"></div>
                </div>
                
                <!-- 30å¤©å†… -->
                <div class="history-group" id="month-group" style="display: none;">
                    <div class="group-header" onclick="toggleGroup('month-group')">
                        <span class="group-title">30å¤©å†…</span>
                        <span class="group-count" id="month-count">0</span>
                    </div>
                    <div class="group-items" id="month-items"></div>
                </div>
                
                <!-- åŠ¨æ€æœˆä»½åˆ†ç»„å®¹å™¨ -->
                <div id="monthly-groups"></div>
                
                <!-- æ›´æ—©çš„è®°å½• -->
                <div class="history-group" id="older-group" style="display: none;">
                    <div class="group-header" onclick="toggleGroup('older-group')">
                        <span class="group-title">æ›´æ—©</span>
                        <span class="group-count" id="older-count">0</span>
                    </div>
                    <div class="group-items" id="older-items"></div>
                </div>
            </div>
        </div>

        <!-- ä¸»èŠå¤©åŒºåŸŸ -->
        <div class="main-chat">
            <div class="chat-header">
            <div style="display: flex; justify-content: space-between; align-items: center; width: 100%;">
                <h1 class="chat-title">AI åŠ©æ‰‹</h1>
                <button class="nav-buttons" onclick="window.location.href='home.html'" style="background-color: #d3eeff; color:black; border: none; padding: 8px 15px; border-radius: 4px; cursor: pointer;">
                    è¿”å›ä¸»é¡µ
                </button>
            </div>
        </div>
            
            <div class="chat-messages" id="chatMessages">
                <div class="message assistant">
                    <div class="message-avatar">AI</div>
                    <div class="message-content">
                        <div class="message-bubble">
                            ä½ å¥½ï¼æˆ‘æ˜¯ä½ çš„AIåŠ©æ‰‹ï¼Œæœ‰ä»€ä¹ˆå¯ä»¥å¸®åŠ©ä½ çš„å—ï¼Ÿ
                        </div>
                    </div>
                </div>
            </div>

            <div class="typing-indicator" id="typingIndicator">
                <span>AIæ­£åœ¨æ€è€ƒ</span>
                <div class="typing-dots">
                    <div class="typing-dot"></div>
                    <div class="typing-dot"></div>
                    <div class="typing-dot"></div>
                </div>
            </div>

            <div class="input-area">
                <div class="input-container">
                    <div class="uploaded-files" id="uploadedFiles"></div>
                    <div class="input-wrapper">
                        <div class="file-upload">
                            <input type="file" id="fileInput" multiple accept=".txt,.pdf,.doc,.docx,.jpg,.jpeg,.png,.gif">
                            <button class="file-upload-btn" onclick="document.getElementById('fileInput').click()">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M21.44 11.05l-9.19 9.19a6 6 0 0 1-8.49-8.49l9.19-9.19a4 4 0 0 1 5.66 5.66L9.64 16.2a2 2 0 0 1-2.83-2.83l8.49-8.49"></path>
                                </svg>
                            </button>
                        </div>
                        <textarea 
                            id="messageInput" 
                            class="message-input" 
                            placeholder="è¾“å…¥ä½ çš„æ¶ˆæ¯..."
                            rows="1"
                        ></textarea>
                        <button class="send-btn" id="sendBtn" onclick="sendMessage()">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <line x1="22" y1="2" x2="11" y2="13"></line>
                                <polygon points="22,2 15,22 11,13 2,9"></polygon>
                            </svg>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let uri = "api/chat";
        let currentChatId = null;
        let uploadedFiles = [];
        let isNewChat = true;
        // åœ¨ç°æœ‰å…¨å±€å˜é‡åæ·»åŠ 
        let currentSessionId = null; // å½“å‰ä¼šè¯çš„session_id

// ç”Ÿæˆå”¯ä¸€ä¼šè¯IDçš„å‡½æ•°
        function generateSessionId() {
             return 'session_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        }
        // ç”¨æˆ·ç®¡ç†å‡½æ•°
        function getCurrentUser() {
            const userStr = localStorage.getItem('user');
            return userStr ? JSON.parse(userStr) : null;
        }
        
        function getUserChatHistoryKey() {
            const user = getCurrentUser();
            return user ? `chatHistory_${user.username}` : 'chatHistory_guest';
        }
        
        let chatHistory = JSON.parse(localStorage.getItem(getUserChatHistoryKey()) || '[]');

        // æ—¶é—´åˆ†ç»„ç®¡ç†ç±»
        class ChatHistoryManager {
            constructor() {
                this.groups = {
                    today: { element: document.getElementById('today-items'), count: 0 },
                    yesterday: { element: document.getElementById('yesterday-items'), count: 0 },
                    week: { element: document.getElementById('week-items'), count: 0 },
                    month: { element: document.getElementById('month-items'), count: 0 },
                    older: { element: document.getElementById('older-items'), count: 0 }
                };
                this.monthlyGroups = new Map();
                this.initializeGroupHeaders();
            }
            
            // åˆå§‹åŒ–åˆ†ç»„å¤´éƒ¨ç‚¹å‡»äº‹ä»¶
            initializeGroupHeaders() {
                document.querySelectorAll('.group-header').forEach(header => {
                    header.addEventListener('click', () => {
                        const group = header.parentElement;
                        group.classList.toggle('collapsed');
                        header.classList.toggle('collapsed');
                    });
                });
            }
            
            // è·å–æ—¶é—´åˆ†ç»„ç±»å‹
            getTimeGroup(timestamp) {
                const now = new Date();
                const date = new Date(timestamp);
                const diffTime = now.getTime() - date.getTime();
                const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));
                
                // ä»Šå¤©
                if (this.isSameDay(now, date)) {
                    return 'today';
                }
                
                // æ˜¨å¤©
                if (diffDays === 1) {
                    return 'yesterday';
                }
                
                // ä¸ƒå¤©å†…
                if (diffDays <= 7) {
                    return 'week';
                }
                
                // 30å¤©å†…
                if (diffDays <= 30) {
                    return 'month';
                }
                
                // æŒ‰æœˆåˆ†ç»„
                const monthKey = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
                return { type: 'monthly', key: monthKey, date: date };
            }
            
            // æ£€æŸ¥æ˜¯å¦ä¸ºåŒä¸€å¤©
            isSameDay(date1, date2) {
                return date1.getFullYear() === date2.getFullYear() &&
                       date1.getMonth() === date2.getMonth() &&
                       date1.getDate() === date2.getDate();
            }
            
            // åˆ›å»ºæœˆä»½åˆ†ç»„
            createMonthlyGroup(monthKey, date) {
                if (this.monthlyGroups.has(monthKey)) {
                    return this.monthlyGroups.get(monthKey);
                }
                
                const monthNames = [
                    'ä¸€æœˆ', 'äºŒæœˆ', 'ä¸‰æœˆ', 'å››æœˆ', 'äº”æœˆ', 'å…­æœˆ',
                    'ä¸ƒæœˆ', 'å…«æœˆ', 'ä¹æœˆ', 'åæœˆ', 'åä¸€æœˆ', 'åäºŒæœˆ'
                ];
                
                const year = date.getFullYear();
                const month = monthNames[date.getMonth()];
                const title = year === new Date().getFullYear() ? month : `${year}å¹´${month}`;
                
                const groupElement = document.createElement('div');
                groupElement.className = 'history-group';
                groupElement.id = `month-${monthKey}`;
                
                groupElement.innerHTML = `
                    <div class="group-header">
                        <span class="group-title">${title}</span>
                        <span class="group-count">0</span>
                    </div>
                    <div class="group-items"></div>
                `;
                
                // æ’å…¥åˆ°æ­£ç¡®ä½ç½®ï¼ˆæŒ‰æ—¶é—´å€’åºï¼‰
                const monthlyContainer = document.getElementById('monthly-groups');
                const existingGroups = Array.from(monthlyContainer.children);
                
                let inserted = false;
                for (let i = 0; i < existingGroups.length; i++) {
                    const existingKey = existingGroups[i].id.replace('month-', '');
                    if (monthKey > existingKey) {
                        monthlyContainer.insertBefore(groupElement, existingGroups[i]);
                        inserted = true;
                        break;
                    }
                }
                
                if (!inserted) {
                    monthlyContainer.appendChild(groupElement);
                }
                
                // æ·»åŠ ç‚¹å‡»äº‹ä»¶
                const header = groupElement.querySelector('.group-header');
                header.addEventListener('click', () => {
                    groupElement.classList.toggle('collapsed');
                    header.classList.toggle('collapsed');
                });
                
                const groupData = {
                    element: groupElement.querySelector('.group-items'),
                    count: 0,
                    header: header
                };
                
                this.monthlyGroups.set(monthKey, groupData);
                return groupData;
            }
            
            // æ·»åŠ èŠå¤©è®°å½•åˆ°å¯¹åº”åˆ†ç»„
            addChatToGroup(chatData) {
                const timeGroup = this.getTimeGroup(chatData.timestamp);
                let targetGroup;
                
                if (typeof timeGroup === 'string') {
                    targetGroup = this.groups[timeGroup];
                } else {
                    // æœˆä»½åˆ†ç»„
                    targetGroup = this.createMonthlyGroup(timeGroup.key, timeGroup.date);
                }
                
                if (!targetGroup) return;
                
                // åˆ›å»ºå†å²è®°å½•é¡¹
                const historyItem = this.createHistoryItem(chatData);
                
                // æ’å…¥åˆ°åˆ†ç»„ä¸­ï¼ˆæ–°çš„åœ¨å‰é¢ï¼‰
                targetGroup.element.insertBefore(historyItem, targetGroup.element.firstChild);
                
                // æ›´æ–°è®¡æ•°
                targetGroup.count++;
                this.updateGroupCount(timeGroup, targetGroup.count);
                
                // æ˜¾ç¤ºåˆ†ç»„
                this.showGroup(timeGroup);
            }
            
            // åˆ›å»ºå†å²è®°å½•é¡¹å…ƒç´ 
            createHistoryItem(chatData) {
                const historyItem = document.createElement('div');
                historyItem.className = 'history-item';
                historyItem.dataset.chatId = chatData.id;
                
                const timeStr = this.formatTime(chatData.timestamp);
                const title = chatData.title || 'æ–°å¯¹è¯';
                
                historyItem.innerHTML = `
                    <div class="history-content">
                        <div class="history-title">${this.escapeHtml(title)}</div>
                        <div class="history-time">${timeStr}</div>
                    </div>
                    <button class="delete-chat-btn" onclick="deleteChatRecord('${chatData.id}', event)" title="åˆ é™¤èŠå¤©è®°å½•">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <polyline points="3,6 5,6 21,6"></polyline>
                            <path d="m19,6v14a2,2 0 0,1 -2,2H7a2,2 0 0,1 -2,-2V6m3,0V4a2,2 0 0,1 2,-2h4a2,2 0 0,1 2,2v2"></path>
                            <line x1="10" y1="11" x2="10" y2="17"></line>
                            <line x1="14" y1="11" x2="14" y2="17"></line>
                        </svg>
                    </button>
                `;
                
                // æ·»åŠ ç‚¹å‡»äº‹ä»¶åˆ°å†…å®¹åŒºåŸŸ
                const historyContent = historyItem.querySelector('.history-content');
                historyContent.addEventListener('click', () => {
                    this.selectChat(chatData.id);
                });
                
                return historyItem;
            }
            // ... existing code ...

// åœ¨handleFileUploadå‡½æ•°ä¸­æ·»åŠ PDFå¤„ç†é€»è¾‘

            // æ ¼å¼åŒ–æ—¶é—´æ˜¾ç¤º
            formatTime(timestamp) {
                const date = new Date(timestamp);
                const now = new Date();
                
                if (this.isSameDay(now, date)) {
                    return date.toLocaleTimeString('zh-CN', { 
                        hour: '2-digit', 
                        minute: '2-digit' 
                    });
                } else {
                    return date.toLocaleDateString('zh-CN', {
                        month: 'short',
                        day: 'numeric'
                    });
                }
            }
            
            // æ›´æ–°åˆ†ç»„è®¡æ•°
            updateGroupCount(timeGroup, count) {
                let countElement;
                
                if (typeof timeGroup === 'string') {
                    countElement = document.querySelector(`#${timeGroup}-group .group-count`);
                } else {
                    const groupElement = document.getElementById(`month-${timeGroup.key}`);
                    countElement = groupElement?.querySelector('.group-count');
                }
                
                if (countElement) {
                    countElement.textContent = count;
                }
            }
            
            // æ˜¾ç¤ºåˆ†ç»„
            showGroup(timeGroup) {
                let groupElement;
                
                if (typeof timeGroup === 'string') {
                    groupElement = document.getElementById(`${timeGroup}-group`);
                } else {
                    groupElement = document.getElementById(`month-${timeGroup.key}`);
                }
                
                if (groupElement) {
                    groupElement.style.display = 'block';
                }
            }
            
            // é€‰æ‹©èŠå¤©è®°å½•
            selectChat(chatId) {
                // ç§»é™¤æ‰€æœ‰activeçŠ¶æ€
                document.querySelectorAll('.history-item.active').forEach(item => {
                    item.classList.remove('active');
                });
                
                // æ·»åŠ activeçŠ¶æ€åˆ°å½“å‰é¡¹
                const selectedItem = document.querySelector(`[data-chat-id="${chatId}"]`);
                if (selectedItem) {
                    selectedItem.classList.add('active');
                }
                
                // åŠ è½½èŠå¤©è®°å½•ï¼ˆè¿™é‡Œéœ€è¦ä¸ç°æœ‰çš„èŠå¤©åŠ è½½é€»è¾‘é›†æˆï¼‰
                this.loadChatHistory(chatId);
            }
            
            // åŠ è½½èŠå¤©å†å²ï¼ˆéœ€è¦ä¸ç°æœ‰é€»è¾‘é›†æˆï¼‰
            loadChatHistory(chatId) {
                // è°ƒç”¨ç°æœ‰çš„èŠå¤©è®°å½•åŠ è½½å‡½æ•°
                console.log('åŠ è½½èŠå¤©è®°å½•:', chatId);
                loadChat(chatId);
            }
            
            // HTMLè½¬ä¹‰
            escapeHtml(text) {
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }
            
            // æ¸…ç©ºæ‰€æœ‰åˆ†ç»„
            clearAllGroups() {
                Object.values(this.groups).forEach(group => {
                    group.element.innerHTML = '';
                    group.count = 0;
                });
                
                this.monthlyGroups.forEach(group => {
                    group.element.innerHTML = '';
                    group.count = 0;
                });
                
                // éšè—æ‰€æœ‰åˆ†ç»„
                document.querySelectorAll('.history-group').forEach(group => {
                    if (group.id !== 'today-group') {
                        group.style.display = 'none';
                    }
                });
                
                // é‡ç½®è®¡æ•°æ˜¾ç¤º
                document.querySelectorAll('.group-count').forEach(count => {
                    count.textContent = '0';
                });
            }
        }

        // åˆå§‹åŒ–å†å²è®°å½•ç®¡ç†å™¨
        const historyManager = new ChatHistoryManager();

        // ç¤ºä¾‹ï¼šæ·»åŠ èŠå¤©è®°å½•çš„å‡½æ•°
        function addChatToHistoryManager(title, timestamp = Date.now()) {
            const chatData = {
                id: 'chat_' + timestamp,
                title: title,
                timestamp: timestamp
            };
            
            historyManager.addChatToGroup(chatData);
            
            // ä¿å­˜åˆ°localStorageï¼ˆå¯é€‰ï¼‰
            saveChatToStorage(chatData);
        }

        // ä¿å­˜èŠå¤©è®°å½•åˆ°æœ¬åœ°å­˜å‚¨
        function saveChatToStorage(chatData) {
            const historyKey = getUserChatHistoryKey();
            const existingChats = JSON.parse(localStorage.getItem(historyKey) || '[]');
            existingChats.unshift(chatData);
            localStorage.setItem(historyKey, JSON.stringify(existingChats));
        }
        function handleFileUpload(event) {
            const files = Array.from(event.target.files);
            files.forEach(file => {
                if (file.size > 10 * 1024 * 1024) { // 10MBé™åˆ¶
                    alert(`æ–‡ä»¶ ${file.name} è¶…è¿‡10MBé™åˆ¶`);
                    return;
                }
                
                // å¦‚æœæ˜¯PDFæ–‡ä»¶ï¼Œè‡ªåŠ¨æå–å†…å®¹
                if (file.type === 'application/pdf') {
                    extractPdfContent(file);
                } else {
                    uploadedFiles.push(file);
                }
            });
            displayUploadedFiles();
            event.target.value = ''; // æ¸…ç©ºinput
        }

        // æ·»åŠ PDFå†…å®¹æå–å‡½æ•°
        function extractPdfContent(file) {
            const formData = new FormData();
            formData.append('resume', file);
            
            // æ˜¾ç¤ºæå–çŠ¶æ€
            const messageInput = document.getElementById('messageInput');
            const originalPlaceholder = messageInput.placeholder;
            messageInput.placeholder = `æ­£åœ¨æå– ${file.name} çš„å†…å®¹...`;
            messageInput.disabled = true;
            
            fetch('/api/extract-pdf', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // å°†æå–çš„æ–‡æœ¬æ·»åŠ åˆ°è¾“å…¥æ¡†
                    const currentText = messageInput.value;
                    const extractedText = `\n\n[PDFæ–‡ä»¶: ${file.name}]\n${data.text}`;
                    messageInput.value = currentText + extractedText;
                    
                    // è‡ªåŠ¨è°ƒæ•´è¾“å…¥æ¡†é«˜åº¦
                    messageInput.style.height = 'auto';
                    messageInput.style.height = Math.min(messageInput.scrollHeight, 120) + 'px';
                    
                    // æ˜¾ç¤ºæˆåŠŸæç¤º
                    showPdfExtractionSuccess(file.name);
                } else {
                    alert(`æå–PDFå¤±è´¥: ${data.message}`);
                }
            })
            .catch(error => {
                console.error('æå–PDFå†…å®¹å¤±è´¥:', error);
                alert('æå–PDFå†…å®¹å¤±è´¥ï¼Œè¯·é‡è¯•');
            })
            .finally(() => {
                // æ¢å¤è¾“å…¥æ¡†çŠ¶æ€
                messageInput.placeholder = originalPlaceholder;
                messageInput.disabled = false;
                messageInput.focus();
            });
        }

        // æ˜¾ç¤ºPDFæå–æˆåŠŸæç¤º
        function showPdfExtractionSuccess(filename) {
            const chatMessages = document.getElementById('chatMessages');
            const successDiv = document.createElement('div');
            successDiv.className = 'pdf-extraction-success';
            successDiv.innerHTML = `
                <div style="
                    background: #e8f5e8;
                    border: 1px solid #4caf50;
                    border-radius: 8px;
                    padding: 12px;
                    margin: 8px 0;
                    color: #2e7d32;
                    font-size: 14px;
                    text-align: center;
                ">
                    ğŸ“„ å·²æˆåŠŸæå– "${filename}" çš„å†…å®¹
                </div>
            `;
            
            chatMessages.appendChild(successDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
            
            // 3ç§’åè‡ªåŠ¨ç§»é™¤æç¤º
            setTimeout(() => {
                if (successDiv.parentNode) {
                    successDiv.parentNode.removeChild(successDiv);
                }
            }, 3000);
        }

        // ä»æœ¬åœ°å­˜å‚¨åŠ è½½èŠå¤©è®°å½•
        function loadChatHistoryFromStorage() {
            const historyKey = getUserChatHistoryKey();
            const chatHistory = JSON.parse(localStorage.getItem(historyKey) || '[]');
            
            historyManager.clearAllGroups();
            
            chatHistory.forEach(chatData => {
                historyManager.addChatToGroup(chatData);
            });
        }

        // åˆ é™¤èŠå¤©è®°å½•å‡½æ•°
        function deleteChatRecord(chatId, event) {
            event.stopPropagation(); // é˜»æ­¢äº‹ä»¶å†’æ³¡
            
            if (confirm('ç¡®å®šè¦åˆ é™¤è¿™æ¡èŠå¤©è®°å½•å—ï¼Ÿ')) {
                // ä»èŠå¤©å†å²ä¸­ç§»é™¤
                const index = chatHistory.findIndex(chat => chat.id === chatId);
                if (index !== -1) {
                    chatHistory.splice(index, 1);
                    
                    // æ›´æ–°æœ¬åœ°å­˜å‚¨
                    const historyKey = getUserChatHistoryKey();
                    localStorage.setItem(historyKey, JSON.stringify(chatHistory));
                    
                    // å¦‚æœåˆ é™¤çš„æ˜¯å½“å‰èŠå¤©ï¼Œå¼€å§‹æ–°å¯¹è¯
                    if (currentChatId === chatId) {
                        startNewChat();
                    }
                    
                    // é‡æ–°åŠ è½½å†å²è®°å½•æ˜¾ç¤º
                    loadChatHistoryFromStorage();
                }
            }
        }

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            // æ£€æŸ¥ç”¨æˆ·ç™»å½•çŠ¶æ€
            const currentUser = getCurrentUser();
            if (!currentUser) {
                // å¦‚æœç”¨æˆ·æœªç™»å½•ï¼Œé‡å®šå‘åˆ°ç™»å½•é¡µé¢
                alert('è¯·å…ˆç™»å½•');
                window.location.href = 'home.html';
                return;
            }
            
            // é‡æ–°åŠ è½½ç”¨æˆ·ç‰¹å®šçš„èŠå¤©å†å²
            chatHistory = JSON.parse(localStorage.getItem(getUserChatHistoryKey()) || '[]');
            if (!currentSessionId) {
                currentSessionId = generateSessionId();
            }
            setupEventListeners();
            loadChatHistoryFromStorage();
        });

        function setupEventListeners() {
            // æ¨¡å‹é€‰æ‹©å™¨
            const selectLLM = document.getElementById('selectLLM');
            selectLLM.addEventListener('change', function() {
                const selectedOption = this.options[this.selectedIndex];
                uri = `api/${selectedOption.value}`;
            });

            // è¾“å…¥æ¡†è‡ªåŠ¨è°ƒæ•´é«˜åº¦
            const messageInput = document.getElementById('messageInput');
            messageInput.addEventListener('input', function() {
                this.style.height = 'auto';
                this.style.height = Math.min(this.scrollHeight, 120) + 'px';
            });

            // å›è½¦å‘é€æ¶ˆæ¯
            messageInput.addEventListener('keydown', function(e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendMessage();
                }
            });

            // æ–‡ä»¶ä¸Šä¼ 
            const fileInput = document.getElementById('fileInput');
            fileInput.addEventListener('change', handleFileUpload);
        }
// åˆ é™¤ç¬¬1475-1485è¡Œçš„é‡å¤å‡½æ•°å®šä¹‰
// function handleFileUpload(event) {
//     const files = Array.from(event.target.files);
//     files.forEach(file => {
//         if (file.size > 10 * 1024 * 1024) {
//             alert(`æ–‡ä»¶ ${file.name} è¶…è¿‡10MBé™åˆ¶`);
//             return;
//         }
//         uploadedFiles.push(file);
//     });
//     displayUploadedFiles();
//     event.target.value = '';
// }

        function displayUploadedFiles() {
            const container = document.getElementById('uploadedFiles');
            container.innerHTML = '';
            
            uploadedFiles.forEach((file, index) => {
                const fileElement = document.createElement('div');
                fileElement.className = 'uploaded-file';
                fileElement.innerHTML = `
                    <span>${file.name}</span>
                    <button class="remove-file" onclick="removeFile(${index})">
                        <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <line x1="18" y1="6" x2="6" y2="18"></line>
                            <line x1="6" y1="6" x2="18" y2="18"></line>
                        </svg>
                    </button>
                `;
                container.appendChild(fileElement);
            });
        }

        function removeFile(index) {
            uploadedFiles.splice(index, 1);
            displayUploadedFiles();
        }

        // åœ¨ç°æœ‰çš„JavaScriptä»£ç ä¸­æ·»åŠ æ€»ç»“ç”Ÿæˆå‡½æ•°

        // ä¿®æ”¹sendMessageå‡½æ•°
        async function sendMessage() {
            const messageInput = document.getElementById('messageInput');
            const content = messageInput.value.trim();
            
            if (!content && uploadedFiles.length === 0) return;
            
            // å¦‚æœæ²¡æœ‰å½“å‰å¯¹è¯ï¼Œåˆ›å»ºæ–°å¯¹è¯
            if (!currentChatId) {
                currentChatId = Date.now().toString();
                if (!currentSessionId) {
                currentSessionId = generateSessionId();
                 }
            }
            
            // åœ¨å‘é€ç¬¬ä¸€æ¡æ¶ˆæ¯æ—¶ï¼Œæ·»åŠ åˆ°å†å²è®°å½•
            if (isNewChat) {
                const chatTitle = content.substring(0, 30) + (content.length > 30 ? '...' : '');
                addChatToHistory(chatTitle);
                isNewChat = false;
            }
            
            // æ˜¾ç¤ºç”¨æˆ·æ¶ˆæ¯åˆ°ç•Œé¢
            let userMessage = content;
            if (uploadedFiles.length > 0) {
                const fileNames = uploadedFiles.map(f => f.name).join(', ');
                userMessage += `\n\n[é™„ä»¶: ${fileNames}]`;
            }
            addMessageToChat('user', userMessage);
            
            // æ¸…ç©ºè¾“å…¥
            messageInput.value = '';
            messageInput.style.height = 'auto';
            const currentUploadedFiles = [...uploadedFiles]; // ä¿å­˜å½“å‰æ–‡ä»¶åˆ—è¡¨
            uploadedFiles = [];
            displayUploadedFiles();
            
            // åˆ›å»ºAIæ¶ˆæ¯æ¡†å¹¶æ˜¾ç¤ºåŠ è½½åŠ¨ç”»
            const chatMessages = document.getElementById('chatMessages');
            const aiMessageDiv = document.createElement('div');
            aiMessageDiv.className = 'message assistant';
            aiMessageDiv.innerHTML = `
                <div class="message-avatar">AI</div>
                <div class="message-content">
                    <div class="message-bubble">
                        <div class="ai-loading">
                            <div class="ai-loading-dots">
                                <div class="ai-loading-dot"></div>
                                <div class="ai-loading-dot"></div>
                                <div class="ai-loading-dot"></div>
                            </div>
                            <span>AIæ­£åœ¨æ€è€ƒä¸­...</span>
                        </div>
                    </div>
                </div>
            `;
            chatMessages.appendChild(aiMessageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
            
            const messageBubble = aiMessageDiv.querySelector('.message-bubble');
            
            // å‘é€è¯·æ±‚
            try {
                const data = {
                    content: content,
                    session_id: currentSessionId, // ä¼ é€’ä¼šè¯ID
                    files: currentUploadedFiles.length > 0 ? currentUploadedFiles : undefined
                };
                
                const response = await fetch(`http://127.0.0.1:8000/${uri}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data),
                });
                
                if (response.ok) {
                    const reader = response.body.getReader();
                    const decoder = new TextDecoder("utf-8");
                    let final_answer = "";
                    let searchSources = null;
                    
                    function read() {
                        reader.read().then(({ done, value }) => {
                            if (done) {
                                // æ˜¾ç¤ºæœ€ç»ˆå›å¤
                                messageBubble.innerHTML = marked.parse(final_answer);
                                
                                // æ˜¾ç¤ºæœç´¢æ¥æºï¼ˆå¦‚æœæœ‰ï¼‰
                                if (searchSources) {
                                    displaySearchSources(searchSources);
                                }
                                
                                // ä¿å­˜åˆ°å†å²è®°å½•
                                if (currentChatId) {
                                    let chat = chatHistory.find(c => c.id === currentChatId);
                                    if (!chat) {
                                        // å¦‚æœæ‰¾ä¸åˆ°èŠå¤©è®°å½•ï¼Œè¯´æ˜å‡ºç°äº†å¼‚å¸¸æƒ…å†µ
                                        // è¿™ç§æƒ…å†µä¸‹ä¸åº”è¯¥é‡æ–°åˆ›å»ºï¼Œå› ä¸º addChatToHistory å·²ç»åˆ›å»ºè¿‡äº†
                                        console.error('Chat not found in history, this should not happen');
                                        return;
                                    }
                                    // åªä¿å­˜æ¶ˆæ¯å†…å®¹ï¼Œä¸é‡æ–°åˆ›å»ºèŠå¤©è®°å½•
                                    let userMessageForHistory = content;
                                    if (currentUploadedFiles.length > 0) {
                                        const fileNames = currentUploadedFiles.map(f => f.name).join(', ');
                                        userMessageForHistory += `\n\n[é™„ä»¶: ${fileNames}]`;
                                    }
                                    chat.messages.push({ role: 'user', content: userMessageForHistory });
                                    chat.messages.push({ role: 'assistant', content: final_answer });
                                    const historyKey = getUserChatHistoryKey();
                                    localStorage.setItem(historyKey, JSON.stringify(chatHistory));
                                    // ç§»é™¤ updateHistoryDisplay() è°ƒç”¨ï¼Œé¿å…é‡å¤æ›´æ–°
                                }
                                return;
                            }
                            
                            const chunk = decoder.decode(value, { stream: true });
                            chunk.split('\r\n').forEach(eventString => {
                                if (eventString.trim()) {
                                    try {
                                        // å°è¯•è§£æJSONæ ¼å¼çš„å“åº”ï¼ˆåŒ…å«æœç´¢æ¥æºï¼‰
                                        const jsonData = JSON.parse(eventString);
                                        if (jsonData.content) {
                                            final_answer += jsonData.content;
                                        }
                                        if (jsonData.search_sources) {
                                            searchSources = jsonData.search_sources;
                                        }
                                    } catch (e) {
                                        // å¦‚æœä¸æ˜¯JSONæ ¼å¼ï¼ŒæŒ‰åŸæ¥çš„æ–¹å¼å¤„ç†
                                        final_answer += eventString;
                                    }
                                    // å®æ—¶æ›´æ–°æ˜¾ç¤ºå†…å®¹
                                    messageBubble.innerHTML = marked.parse(final_answer);
                                }
                            });
                            
                            chatMessages.scrollTop = chatMessages.scrollHeight;
                            read();
                        }).catch(error => {
                            console.error('Stream error', error);
                            messageBubble.innerHTML = 'æŠ±æ­‰ï¼Œè¿æ¥å¼‚å¸¸ï¼Œè¯·ç¨åé‡è¯•ã€‚';
                        });
                    }
                    
                    read();
                } else {
                    messageBubble.innerHTML = 'æŠ±æ­‰ï¼ŒæœåŠ¡å™¨å“åº”å¼‚å¸¸ï¼Œè¯·ç¨åé‡è¯•ã€‚';
                }
            } catch (error) {
                console.error('Fetch error:', error);
                messageBubble.innerHTML = 'æŠ±æ­‰ï¼Œç½‘ç»œè¿æ¥å¼‚å¸¸ï¼Œè¯·æ£€æŸ¥ç½‘ç»œåé‡è¯•ã€‚';
            }
        }
        
        // æ·»åŠ èŠå¤©åˆ°å†å²è®°å½•çš„å‡½æ•°
        function addChatToHistory(chatTitle) {
            if (!currentChatId) return;
            
            // æ£€æŸ¥æ˜¯å¦å·²ç»å­˜åœ¨
            const existingChat = chatHistory.find(c => c.id === currentChatId);
            if (existingChat) return;
            
            // åˆ›å»ºæ–°çš„èŠå¤©è®°å½•
            const newChat = {
                id: currentChatId,
                sessionId: currentSessionId, // ä¿å­˜ä¼šè¯ID
                timestamp: Date.now(),
                messages: [],
                title: chatTitle
            };
            
            // æ·»åŠ åˆ°å†å²è®°å½•å¼€å¤´
            chatHistory.unshift(newChat);
            const historyKey = getUserChatHistoryKey();
            localStorage.setItem(historyKey, JSON.stringify(chatHistory));
            
            // åªä½¿ç”¨ historyManager æ›´æ–°UI
            historyManager.addChatToGroup(newChat);
        }
        
        // æ–°å¢å‡½æ•°ï¼šæ˜¾ç¤ºæœç´¢çŠ¶æ€
        function showSearchStatus() {
            const chatMessages = document.getElementById('chatMessages');
            const searchStatusDiv = document.createElement('div');
            searchStatusDiv.id = 'searchStatus';
            searchStatusDiv.className = 'message assistant';
            searchStatusDiv.innerHTML = `
                <div class="message-avatar">AI</div>
                <div class="message-content">
                    <div class="message-bubble">
                        <div class="search-status">
                            <span class="search-icon">ğŸ”</span>
                            <span>å·²ä¸ºæ‚¨æœç´¢ 8ä¸ªç½‘é¡µ</span>
                        </div>
                    </div>
                </div>
            `;
            chatMessages.appendChild(searchStatusDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }
        
        // æ–°å¢å‡½æ•°ï¼šéšè—æœç´¢çŠ¶æ€
        function hideSearchStatus() {
            const searchStatus = document.getElementById('searchStatus');
            if (searchStatus) {
                searchStatus.remove();
            }
        }
        
        // æ–°å¢å‡½æ•°ï¼šæ˜¾ç¤ºAIå›å¤åŠ è½½åŠ¨ç”»
        function showAILoadingAnimation() {
            const chatMessages = document.getElementById('chatMessages');
            const loadingDiv = document.createElement('div');
            loadingDiv.id = 'aiLoadingAnimation';
            loadingDiv.className = 'message assistant';
            loadingDiv.innerHTML = `
                <div class="message-avatar">AI</div>
                <div class="message-content">
                    <div class="message-bubble ai-loading-message">
                        <div class="ai-loading">
                            <div class="ai-loading-dots">
                                <div class="ai-loading-dot"></div>
                                <div class="ai-loading-dot"></div>
                                <div class="ai-loading-dot"></div>
                            </div>
                            <span>AIæ­£åœ¨æ€è€ƒä¸­...</span>
                        </div>
                    </div>
                </div>
            `;
            chatMessages.appendChild(loadingDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }
        
        // æ–°å¢å‡½æ•°ï¼šéšè—AIå›å¤åŠ è½½åŠ¨ç”»
        function hideAILoadingAnimation() {
            const loadingAnimation = document.getElementById('aiLoadingAnimation');
            if (loadingAnimation) {
                loadingAnimation.remove();
            }
        }
        
        // æ–°å¢å‡½æ•°ï¼šæ˜¾ç¤ºæ€è€ƒçŠ¶æ€
        function showThinkingStatus() {
            const chatMessages = document.getElementById('chatMessages');
            const thinkingStatusDiv = document.createElement('div');
            thinkingStatusDiv.id = 'thinkingStatus';
            thinkingStatusDiv.className = 'message assistant';
            thinkingStatusDiv.innerHTML = `
                <div class="message-avatar">AI</div>
                <div class="message-content">
                    <div class="message-bubble">
                        <div class="thinking-status">
                            <div class="loading-spinner"></div>
                            <span>è¯·ç¨ç­‰ï¼Œæ¨¡å‹æ­£åœ¨å­å“§å­å“§ä¸ºæ‚¨å¯»æ‰¾ç­”æ¡ˆ</span>
                        </div>
                    </div>
                </div>
            `;
            chatMessages.appendChild(thinkingStatusDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }
        
        // æ–°å¢å‡½æ•°ï¼šéšè—æ€è€ƒçŠ¶æ€
        function hideThinkingStatus() {
            const thinkingStatus = document.getElementById('thinkingStatus');
            if (thinkingStatus) {
                thinkingStatus.remove();
            }
        }
        
        // æ–°å¢å‡½æ•°ï¼šæ˜¾ç¤ºæœç´¢æ¥æº
        function displaySearchSources(sources) {
            // è¿™é‡Œå¯ä»¥åœ¨ä¾§è¾¹æ æˆ–å…¶ä»–ä½ç½®æ˜¾ç¤ºæœç´¢æ¥æº
            console.log('æœç´¢æ¥æº:', sources);
        }
        function generateChatSummary(messages) {
            if (messages.length <= 1) return 'æ–°å¯¹è¯';
            
            // è·å–ç”¨æˆ·çš„ç¬¬ä¸€æ¡æ¶ˆæ¯ä½œä¸ºä¸»é¢˜
            const userMessages = messages.filter(msg => msg.role === 'user');
            if (userMessages.length === 0) return 'æ–°å¯¹è¯';
            
            const firstUserMessage = userMessages[0].content;
            
            // åŸºäºå…³é”®è¯ç”Ÿæˆç®€å•æ€»ç»“
            const keywords = {
                'ç®€å†': 'ç®€å†å’¨è¯¢',
                'é¢è¯•': 'é¢è¯•æŒ‡å¯¼', 
                'å·¥ä½œ': 'èŒä¸šå’¨è¯¢',
                'è–ªèµ„': 'è–ªèµ„å’¨è¯¢',
                'æŠ€æœ¯': 'æŠ€æœ¯å’¨è¯¢',
                'å¼€å‘': 'å¼€å‘ç›¸å…³',
                'ç¼–ç¨‹': 'ç¼–ç¨‹é—®é¢˜',
                'Python': 'Pythonç›¸å…³',
                'Java': 'Javaç›¸å…³',
                'JavaScript': 'JSç›¸å…³',
                'å‰ç«¯': 'å‰ç«¯å¼€å‘',
                'åç«¯': 'åç«¯å¼€å‘',
                'æ•°æ®åº“': 'æ•°æ®åº“é—®é¢˜',
                'ç®—æ³•': 'ç®—æ³•é—®é¢˜',
                'é¡¹ç›®': 'é¡¹ç›®å’¨è¯¢',
                'å­¦ä¹ ': 'å­¦ä¹ æŒ‡å¯¼',
                'è½¬è¡Œ': 'è½¬è¡Œå’¨è¯¢',
                'æ‹›è˜': 'æ‹›è˜ä¿¡æ¯',
                'å…¬å¸': 'å…¬å¸å’¨è¯¢'
            };
            
            // æ£€æŸ¥å…³é”®è¯åŒ¹é…
            for (const [keyword, summary] of Object.entries(keywords)) {
                if (firstUserMessage.includes(keyword)) {
                    return summary;
                }
            }
            
            // å¦‚æœæ²¡æœ‰åŒ¹é…çš„å…³é”®è¯ï¼Œè¿”å›æˆªæ–­çš„ç¬¬ä¸€æ¡æ¶ˆæ¯
            return firstUserMessage.length > 15 ? 
                firstUserMessage.substring(0, 15) + '...' : 
                firstUserMessage;
        }
        
        // åˆ†ç»„åˆ‡æ¢å‡½æ•°
        function toggleGroup(groupId) {
            const group = document.getElementById(groupId);
            if (group) {
                group.classList.toggle('collapsed');
                const header = group.querySelector('.group-header');
                if (header) {
                    header.classList.toggle('collapsed');
                }
            }
        }

        // è·å–æ—¶é—´åˆ†ç»„
        function getTimeGroup(timestamp) {
            const now = new Date();
            const date = new Date(timestamp);
            const diffTime = now.getTime() - date.getTime();
            const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));
            
            // æ£€æŸ¥æ˜¯å¦æ˜¯ä»Šå¤©
            const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
            const chatDate = new Date(date.getFullYear(), date.getMonth(), date.getDate());
            
            if (chatDate.getTime() === today.getTime()) {
                return 'today';
            }
            
            // æ£€æŸ¥æ˜¯å¦æ˜¯æ˜¨å¤©
            const yesterday = new Date(today.getTime() - 24 * 60 * 60 * 1000);
            if (chatDate.getTime() === yesterday.getTime()) {
                return 'yesterday';
            }
            
            // æ£€æŸ¥æ˜¯å¦åœ¨ä¸ƒå¤©å†…
            if (diffDays <= 7) {
                return 'week';
            }
            
            // æ£€æŸ¥æ˜¯å¦åœ¨30å¤©å†…
            if (diffDays <= 30) {
                return 'month';
            }
            
            // æ£€æŸ¥æ˜¯å¦åœ¨åŒä¸€å¹´
            if (date.getFullYear() === now.getFullYear()) {
                return `month-${date.getFullYear()}-${date.getMonth()}`;
            }
            
            // æ›´æ—©çš„è®°å½•
            return 'older';
        }

        // åˆ›å»ºæœˆä»½åˆ†ç»„
        function createMonthlyGroup(year, month) {
            const monthNames = [
                'ä¸€æœˆ', 'äºŒæœˆ', 'ä¸‰æœˆ', 'å››æœˆ', 'äº”æœˆ', 'å…­æœˆ',
                'ä¸ƒæœˆ', 'å…«æœˆ', 'ä¹æœˆ', 'åæœˆ', 'åä¸€æœˆ', 'åäºŒæœˆ'
            ];
            
            const groupId = `month-${year}-${month}`;
            const groupTitle = `${year}å¹´${monthNames[month]}`;
            
            const groupDiv = document.createElement('div');
            groupDiv.className = 'history-group';
            groupDiv.id = groupId;
            groupDiv.innerHTML = `
                <div class="group-header" onclick="toggleGroup('${groupId}')">
                    <span class="group-title">${groupTitle}</span>
                    <span class="group-count" id="${groupId}-count">0</span>
                </div>
                <div class="group-items" id="${groupId}-items"></div>
            `;
            
            return groupDiv;
        }

        // ä¿®æ”¹updateHistoryDisplayå‡½æ•°
        function updateHistoryDisplay() {
            // æ¸…ç©ºæ‰€æœ‰åˆ†ç»„
            const groups = ['today', 'yesterday', 'week', 'month', 'older'];
            groups.forEach(groupName => {
                const itemsContainer = document.getElementById(`${groupName}-items`);
                const countElement = document.getElementById(`${groupName}-count`);
                const groupElement = document.getElementById(`${groupName}-group`);
                
                if (itemsContainer) itemsContainer.innerHTML = '';
                if (countElement) countElement.textContent = '0';
                if (groupElement) groupElement.style.display = 'none';
            });
            
            // æ¸…ç©ºåŠ¨æ€æœˆä»½åˆ†ç»„
            const monthlyGroupsContainer = document.getElementById('monthly-groups');
            monthlyGroupsContainer.innerHTML = '';
            
            // æŒ‰æ—¶é—´åˆ†ç»„èŠå¤©è®°å½•
            const groupedChats = {
                today: [],
                yesterday: [],
                week: [],
                month: [],
                older: []
            };
            
            const monthlyGroups = {};
            
            chatHistory.forEach(chat => {
                const group = getTimeGroup(chat.timestamp);
                
                if (group.startsWith('month-')) {
                    if (!monthlyGroups[group]) {
                        monthlyGroups[group] = [];
                    }
                    monthlyGroups[group].push(chat);
                } else if (groupedChats[group]) {
                    groupedChats[group].push(chat);
                }
            });
            
            // æ¸²æŸ“åŸºç¡€åˆ†ç»„
            Object.keys(groupedChats).forEach(groupName => {
                const chats = groupedChats[groupName];
                if (chats.length > 0) {
                    renderChatGroup(groupName, chats);
                }
            });
            
            // æ¸²æŸ“æœˆä»½åˆ†ç»„
            const sortedMonthlyKeys = Object.keys(monthlyGroups).sort((a, b) => {
                const [, yearA, monthA] = a.split('-').map(Number);
                const [, yearB, monthB] = b.split('-').map(Number);
                return (yearB * 12 + monthB) - (yearA * 12 + monthA);
            });
            
            sortedMonthlyKeys.forEach(groupKey => {
                const [, year, month] = groupKey.split('-').map(Number);
                const groupDiv = createMonthlyGroup(year, month);
                monthlyGroupsContainer.appendChild(groupDiv);
                renderChatGroup(groupKey, monthlyGroups[groupKey]);
            });
        }

        // æ¸²æŸ“èŠå¤©åˆ†ç»„
        function renderChatGroup(groupName, chats) {
            const itemsContainer = document.getElementById(`${groupName}-items`);
            const countElement = document.getElementById(`${groupName}-count`);
            const groupElement = document.getElementById(`${groupName}-group`);
            
            if (!itemsContainer) return;
            
            // æ˜¾ç¤ºåˆ†ç»„
            if (groupElement) {
                groupElement.style.display = 'block';
            }
            
            // æ›´æ–°è®¡æ•°
            if (countElement) {
                countElement.textContent = chats.length.toString();
            }
            
            // æ¸²æŸ“èŠå¤©é¡¹ç›®
            chats.forEach(chat => {
                const historyItem = document.createElement('div');
                historyItem.className = `history-item ${chat.id === currentChatId ? 'active' : ''}`;
                historyItem.onclick = () => loadChat(chat.id);
                
                const title = generateChatSummary(chat.messages);
                const timeStr = formatChatTime(chat.timestamp);
                
                historyItem.innerHTML = `
                    <div class="history-content">
                        <div class="history-title">${title}</div>
                        <div class="history-time">${timeStr}</div>
                    </div>
                    <button class="delete-chat-btn" onclick="deleteChatRecord('${chat.id}', event)" title="åˆ é™¤èŠå¤©è®°å½•">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <polyline points="3,6 5,6 21,6"></polyline>
                            <path d="m19,6v14a2,2 0 0,1 -2,2H7a2,2 0 0,1 -2,-2V6m3,0V4a2,2 0 0,1 2,-2h4a2,2 0 0,1 2,2v2"></path>
                            <line x1="10" y1="11" x2="10" y2="17"></line>
                            <line x1="14" y1="11" x2="14" y2="17"></line>
                        </svg>
                    </button>
                `;
                
                // ä¸ºå†…å®¹åŒºåŸŸæ·»åŠ ç‚¹å‡»äº‹ä»¶
                const historyContent = historyItem.querySelector('.history-content');
                historyContent.addEventListener('click', () => loadChat(chat.id));
                
                itemsContainer.appendChild(historyItem);
            });
        }

        // æ ¼å¼åŒ–èŠå¤©æ—¶é—´
        function formatChatTime(timestamp) {
            const date = new Date(timestamp);
            const now = new Date();
            const diffTime = now.getTime() - date.getTime();
            const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));
            
            if (diffDays === 0) {
                return date.toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit' });
            } else if (diffDays === 1) {
                return 'æ˜¨å¤© ' + date.toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit' });
            } else if (diffDays <= 7) {
                const weekdays = ['å‘¨æ—¥', 'å‘¨ä¸€', 'å‘¨äºŒ', 'å‘¨ä¸‰', 'å‘¨å››', 'å‘¨äº”', 'å‘¨å…­'];
                return weekdays[date.getDay()];
            } else {
                return date.toLocaleDateString('zh-CN', { month: 'short', day: 'numeric' });
            }
        }
        
        // ä¿®æ”¹startNewChatå‡½æ•°ä¸­ä¿å­˜å¯¹è¯çš„éƒ¨åˆ†
        function startNewChat() {
            // 1. ä¿å­˜å½“å‰å¯¹è¯åˆ°å†å²è®°å½•ï¼ˆå¦‚æœå­˜åœ¨ä¸”æœ‰æ¶ˆæ¯ï¼‰
            console.log("è°ƒç”¨startnewchat"); 
            if (currentChatId) {
                const currentChat = chatHistory.find(c => c.id === currentChatId);
                const chatMessages = document.getElementById('chatMessages');
                const messages = chatMessages.querySelectorAll('.message');
                
                // å¦‚æœå½“å‰å¯¹è¯æœ‰æ¶ˆæ¯ä½†è¿˜æ²¡ä¿å­˜åˆ°å†å²è®°å½•ä¸­
                if (messages.length > 1 && !currentChat) {
                    const newChat = {
                        id: currentChatId,
                        sessionId: currentSessionId, 
                        timestamp: Date.now(),
                        messages: []
                    };
                    
                    // æå–æ‰€æœ‰æ¶ˆæ¯
                    messages.forEach(messageElement => {
                        const isUser = messageElement.classList.contains('user');
                        const content = messageElement.querySelector('.message-bubble').textContent || messageElement.querySelector('.message-bubble').innerText;
                        newChat.messages.push({
                            role: isUser ? 'user' : 'assistant',
                            content: content.trim()
                        });
                    });
                    
                    // ç”Ÿæˆæ€»ç»“å¹¶ä¿å­˜
                    newChat.summary = generateChatSummary(newChat.messages);
                    
                    // æ·»åŠ åˆ°å†å²è®°å½•å¼€å¤´
                    chatHistory.unshift(newChat);
                    localStorage.setItem('chatHistory', JSON.stringify(chatHistory));
                }
            }
            
            // 2. åˆ›å»ºæ–°çš„å¯¹è¯ID
            currentChatId = Date.now().toString();
            currentSessionId = generateSessionId(); // ç”Ÿæˆæ–°çš„ä¼šè¯ID
            // 3. æ¸…ç©ºå½“å‰èŠå¤©ç•Œé¢
            const chatMessages = document.getElementById('chatMessages');
            chatMessages.innerHTML = `
                <div class="message assistant">
                    <div class="message-avatar">AI</div>
                    <div class="message-content">
                        <div class="message-bubble">
                            ä½ å¥½ï¼æˆ‘æ˜¯ä½ çš„AIåŠ©æ‰‹ï¼Œæœ‰ä»€ä¹ˆå¯ä»¥å¸®åŠ©ä½ çš„å—ï¼Ÿ
                        </div>
                    </div>
                </div>
            `;
            
            // 4. æ¸…ç©ºè¾“å…¥æ¡†å’Œä¸Šä¼ æ–‡ä»¶
            const messageInput = document.getElementById('messageInput');
            if (messageInput) {
                messageInput.value = '';
                messageInput.style.height = 'auto';
            }
            
            // æ¸…ç©ºä¸Šä¼ çš„æ–‡ä»¶
            uploadedFiles = [];
            displayUploadedFiles();
            
            // 5. éšè—æ‰“å­—æŒ‡ç¤ºå™¨
            hideTypingIndicator();
            
            // 6. æ›´æ–°å†å²è®°å½•æ˜¾ç¤º
            updateHistoryDisplay();
            
            // 7. æ»šåŠ¨åˆ°æ¶ˆæ¯åŒºåŸŸé¡¶éƒ¨
            chatMessages.scrollTop = 0;
            
            // 8. è®¾ç½®ä¸ºæ–°å¯¹è¯çŠ¶æ€
            isNewChat = true;
            
            // 9. ç§»é™¤æ‰€æœ‰activeçŠ¶æ€
            document.querySelectorAll('.history-item.active').forEach(item => {
                item.classList.remove('active');
            });
            console.log('æ–°å¯¹è¯å·²åˆ›å»ºï¼ŒID:', currentChatId, 'ä¼šè¯ID:', currentSessionId);
        }
        
        // ä¸ºæ–°å»ºèŠå¤©æŒ‰é’®æ·»åŠ äº‹ä»¶ç›‘å¬å™¨
        document.addEventListener('DOMContentLoaded', function() {
            const newChatBtn = document.querySelector('.new-chat-btn');
            if (newChatBtn) {
                newChatBtn.addEventListener('click', () => {
                    startNewChat();
                    
                    // ç§»é™¤æ‰€æœ‰activeçŠ¶æ€
                    document.querySelectorAll('.history-item.active').forEach(item => {
                        item.classList.remove('active');
                    });
                });
            }
        });

        function loadChatHistory() {
            updateHistoryDisplay();
            if (chatHistory.length > 0) {
                loadChat(chatHistory[0].id);
            }
        }



        function loadChat(chatId) {
            currentChatId = chatId;
            const chat = chatHistory.find(c => c.id === chatId);
            if (!chat) return;
            currentSessionId = chat.sessionId || generateSessionId();
             // å¦‚æœå†å²è®°å½•ä¸­æ²¡æœ‰sessionIdï¼Œæ›´æ–°å¹¶ä¿å­˜
            if (!chat.sessionId) {
                chat.sessionId = currentSessionId;
                const historyKey = getUserChatHistoryKey();
                localStorage.setItem(historyKey, JSON.stringify(chatHistory));
            }console.log('åŠ è½½èŠå¤©è®°å½•ï¼ŒID:', chatId, 'ä¼šè¯ID:', currentSessionId);
            
            const chatMessages = document.getElementById('chatMessages');
            chatMessages.innerHTML = '';
            
            chat.messages.forEach(message => {
                addMessageToChat(message.role, message.content, false);
            });
            
            // ç§»é™¤ updateHistoryDisplay() è°ƒç”¨ï¼Œé¿å…é‡å¤æ›´æ–°
            // åªæ›´æ–°activeçŠ¶æ€
            document.querySelectorAll('.history-item.active').forEach(item => {
                item.classList.remove('active');
            });
            const selectedItem = document.querySelector(`[data-chat-id="${chatId}"]`);
            if (selectedItem) {
                selectedItem.classList.add('active');
            }
        }

        function addMessageToChat(role, content, isNew = true) {
            const chatMessages = document.getElementById('chatMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${role}`;
            messageDiv.setAttribute('data-message-id', Date.now() + Math.random()); // æ·»åŠ å”¯ä¸€ID
            
            const avatar = role === 'user' ? 'ä½ ' : 'AI';
            
            // æ ¹æ®è§’è‰²ç”Ÿæˆä¸åŒçš„æ“ä½œæŒ‰é’®
            let actionButtons = '';
            if (role === 'assistant') {
                // AIæ¶ˆæ¯ï¼šé‡æ–°ç”Ÿæˆ + å¤åˆ¶
                actionButtons = `
                    <div class="message-actions">
                        <button class="action-btn regenerate-btn" onclick="regenerateMessage(this)" title="é‡æ–°ç”Ÿæˆ">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M1 4v6h6"/>
                                <path d="M23 20v-6h-6"/>
                                <path d="M20.49 9A9 9 0 0 0 5.64 5.64L1 10m22 4l-4.64 4.36A9 9 0 0 1 3.51 15"/>
                            </svg>
                        </button>
                        <button class="action-btn copy-btn" onclick="copyMessage(this)" title="å¤åˆ¶">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <rect x="9" y="9" width="13" height="13" rx="2" ry="2"/>
                                <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/>
                            </svg>
                        </button>
                    </div>`;
            } else {
                // ç”¨æˆ·æ¶ˆæ¯ï¼šå¤åˆ¶ + åˆ é™¤
                actionButtons = `
                    <div class="message-actions">
                        <button class="action-btn copy-btn" onclick="copyMessage(this)" title="å¤åˆ¶">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <rect x="9" y="9" width="13" height="13" rx="2" ry="2"/>
                                <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/>
                            </svg>
                        </button>
                        <button class="action-btn delete-btn" onclick="deleteMessage(this)" title="åˆ é™¤">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <polyline points="3,6 5,6 21,6"/>
                                <path d="M19,6v14a2,2,0,0,1-2,2H7a2,2,0,0,1-2-2V6m3,0V4a2,2,0,0,1,2-2h4a2,2,0,0,1,2,2V6"/>
                                <line x1="10" y1="11" x2="10" y2="17"/>
                                <line x1="14" y1="11" x2="14" y2="17"/>
                            </svg>
                        </button>
                    </div>`;
            }
            
            messageDiv.innerHTML = `
                <div class="message-avatar">${avatar}</div>
                <div class="message-content">
                    <div class="message-bubble">
                        ${role === 'assistant' ? marked.parse(content) : content}
                    </div>
                    ${actionButtons}
                </div>
            `;
            
            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
            
            // ç§»é™¤è¿™é‡Œçš„å†å²è®°å½•ä¿å­˜é€»è¾‘ï¼Œé¿å…é‡å¤
            // å†å²è®°å½•çš„ä¿å­˜ç»Ÿä¸€åœ¨ sendMessage å‡½æ•°ä¸­å¤„ç†
        }

        function showTypingIndicator() {
            document.getElementById('typingIndicator').style.display = 'flex';
        }

        function hideTypingIndicator() {
            document.getElementById('typingIndicator').style.display = 'none';
        }

        // æ¶ˆæ¯æ“ä½œåŠŸèƒ½
        
        // å¤åˆ¶æ¶ˆæ¯å†…å®¹
        function copyMessage(button) {
            const messageDiv = button.closest('.message');
            const messageBubble = messageDiv.querySelector('.message-bubble');
            const content = messageBubble.textContent || messageBubble.innerText;
            
            navigator.clipboard.writeText(content.trim()).then(() => {
                // æ˜¾ç¤ºå¤åˆ¶æˆåŠŸæç¤º
                showToast('å·²å¤åˆ¶åˆ°å‰ªè´´æ¿');
            }).catch(err => {
                console.error('å¤åˆ¶å¤±è´¥:', err);
                showToast('å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨é€‰æ‹©æ–‡æœ¬');
            });
        }
        
        // åˆ é™¤ç”¨æˆ·æ¶ˆæ¯
        function deleteMessage(button) {
            if (confirm('ç¡®å®šè¦åˆ é™¤è¿™æ¡æ¶ˆæ¯å—ï¼Ÿ')) {
                const messageDiv = button.closest('.message');
                const messageId = messageDiv.getAttribute('data-message-id');
                
                // ä»DOMä¸­ç§»é™¤
                messageDiv.remove();
                
                // ä»å†å²è®°å½•ä¸­ç§»é™¤
                updateChatHistoryAfterDelete(messageId);
                
                showToast('æ¶ˆæ¯å·²åˆ é™¤');
            }
        }
        
        // é‡æ–°ç”ŸæˆAIå›å¤
        function regenerateMessage(button) {
            const messageDiv = button.closest('.message');
            const chatMessages = document.getElementById('chatMessages');
            const messages = Array.from(chatMessages.querySelectorAll('.message'));
            const currentIndex = messages.indexOf(messageDiv);
            
            if (currentIndex === -1) return;
            
            // æ‰¾åˆ°è§¦å‘é‡æ–°ç”Ÿæˆçš„ç”¨æˆ·æ¶ˆæ¯
            let userMessageIndex = -1;
            for (let i = currentIndex - 1; i >= 0; i--) {
                if (messages[i].classList.contains('user')) {
                    userMessageIndex = i;
                    break;
                }
            }
            
            if (userMessageIndex === -1) {
                showToast('æ— æ³•æ‰¾åˆ°å¯¹åº”çš„ç”¨æˆ·æ¶ˆæ¯');
                return;
            }
            
            // åˆ é™¤å½“å‰AIæ¶ˆæ¯åŠå…¶ä¹‹åçš„æ‰€æœ‰æ¶ˆæ¯
            for (let i = messages.length - 1; i >= currentIndex; i--) {
                messages[i].remove();
            }
            
            // è·å–ç”¨æˆ·æ¶ˆæ¯å†…å®¹
            const userMessage = messages[userMessageIndex].querySelector('.message-bubble').textContent.trim();
            
            // é‡æ–°å‘é€è¯·æ±‚
            regenerateAIResponse(userMessage);
            
            // æ›´æ–°å†å²è®°å½•
            updateChatHistoryAfterRegenerate(currentIndex);
        }
        
        // é‡æ–°ç”ŸæˆAIå“åº”
        async function regenerateAIResponse(userMessage) {
            const chatMessages = document.getElementById('chatMessages');
            
            // æ˜¾ç¤ºAIæ­£åœ¨æ€è€ƒ
            showAILoadingAnimation();
            
            try {
                const selectLLM = document.getElementById('selectLLM');
                const uri = `api/${selectLLM.value}`;
                
                const data = {
                    content: userMessage,
                    session_id: currentSessionId
                };
                
                const response = await fetch(`http://127.0.0.1:8000/${uri}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data),
                });
                
                // éšè—åŠ è½½åŠ¨ç”»
                hideAILoadingAnimation();
                
                if (response.ok) {
                    // æ·»åŠ æ–°çš„AIæ¶ˆæ¯å®¹å™¨
                    const messageDiv = document.createElement('div');
                    messageDiv.className = 'message assistant';
                    messageDiv.setAttribute('data-message-id', Date.now() + Math.random());
                    
                    messageDiv.innerHTML = `
                        <div class="message-avatar">AI</div>
                        <div class="message-content">
                            <div class="message-bubble"></div>
                            <div class="message-actions">
                                <button class="action-btn regenerate-btn" onclick="regenerateMessage(this)" title="é‡æ–°ç”Ÿæˆ">
                                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M1 4v6h6"/>
                                        <path d="M23 20v-6h-6"/>
                                        <path d="M20.49 9A9 9 0 0 0 5.64 5.64L1 10m22 4l-4.64 4.36A9 9 0 0 1 3.51 15"/>
                                    </svg>
                                </button>
                                <button class="action-btn copy-btn" onclick="copyMessage(this)" title="å¤åˆ¶">
                                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <rect x="9" y="9" width="13" height="13" rx="2" ry="2"/>
                                        <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/>
                                    </svg>
                                </button>
                            </div>
                        </div>
                    `;
                    
                    chatMessages.appendChild(messageDiv);
                    const messageBubble = messageDiv.querySelector('.message-bubble');
                    
                    // å¤„ç†æµå¼å“åº”
                    const reader = response.body.getReader();
                    const decoder = new TextDecoder("utf-8");
                    let final_answer = "";
                    
                    function read() {
                        reader.read().then(({ done, value }) => {
                            if (done) {
                                messageBubble.innerHTML = marked.parse(final_answer);
                                // ä¿å­˜åˆ°å†å²è®°å½•
                                saveRegeneratedMessage(userMessage, final_answer);
                                return;
                            }
                            
                            const chunk = decoder.decode(value, { stream: true });
                            chunk.split('\r\n').forEach(eventString => {
                                if (eventString.trim()) {
                                    try {
                                        const jsonData = JSON.parse(eventString);
                                        if (jsonData.content) {
                                            final_answer += jsonData.content;
                                        }
                                    } catch (e) {
                                        final_answer += eventString;
                                    }
                                    messageBubble.innerHTML = marked.parse(final_answer);
                                }
                            });
                            
                            chatMessages.scrollTop = chatMessages.scrollHeight;
                            read();
                        }).catch(error => {
                            console.error('Stream error', error);
                            messageBubble.innerHTML = 'æŠ±æ­‰ï¼Œé‡æ–°ç”Ÿæˆå¤±è´¥ï¼Œè¯·ç¨åé‡è¯•ã€‚';
                        });
                    }
                    
                    read();
                } else {
                    showToast('é‡æ–°ç”Ÿæˆå¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
                }
            } catch (error) {
                hideAILoadingAnimation();
                console.error('Regenerate error:', error);
                showToast('ç½‘ç»œè¿æ¥å¼‚å¸¸ï¼Œè¯·æ£€æŸ¥ç½‘ç»œåé‡è¯•');
            }
        }
        
        // æ˜¾ç¤ºæç¤ºæ¶ˆæ¯
        function showToast(message) {
            // åˆ›å»ºæç¤ºå…ƒç´ 
            const toast = document.createElement('div');
            toast.className = 'toast';
            toast.textContent = message;
            toast.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: #374151;
                color: white;
                padding: 12px 16px;
                border-radius: 6px;
                font-size: 14px;
                z-index: 10000;
                opacity: 0;
                transition: opacity 0.3s ease;
            `;
            
            document.body.appendChild(toast);
            
            // æ˜¾ç¤ºåŠ¨ç”»
            setTimeout(() => {
                toast.style.opacity = '1';
            }, 100);
            
            // 3ç§’åè‡ªåŠ¨æ¶ˆå¤±
            setTimeout(() => {
                toast.style.opacity = '0';
                setTimeout(() => {
                    document.body.removeChild(toast);
                }, 300);
            }, 3000);
        }
        
        // æ›´æ–°å†å²è®°å½•ï¼ˆåˆ é™¤æ¶ˆæ¯åï¼‰
        function updateChatHistoryAfterDelete(messageId) {
            if (!currentChatId) return;
            
            const chat = chatHistory.find(c => c.id === currentChatId);
            if (chat) {
                // é‡æ–°æ”¶é›†å½“å‰æ˜¾ç¤ºçš„æ‰€æœ‰æ¶ˆæ¯
                const chatMessages = document.getElementById('chatMessages');
                const messages = chatMessages.querySelectorAll('.message');
                
                chat.messages = [];
                messages.forEach(messageElement => {
                    const isUser = messageElement.classList.contains('user');
                    const content = messageElement.querySelector('.message-bubble').textContent || messageElement.querySelector('.message-bubble').innerText;
                    chat.messages.push({
                        role: isUser ? 'user' : 'assistant',
                        content: content.trim()
                    });
                });
                
                // æ›´æ–°æ€»ç»“
                chat.summary = generateChatSummary(chat.messages);
                
                // ä¿å­˜åˆ°localStorage
                const historyKey = getUserChatHistoryKey();
                localStorage.setItem(historyKey, JSON.stringify(chatHistory));
            }
        }
        
        // æ›´æ–°å†å²è®°å½•ï¼ˆé‡æ–°ç”Ÿæˆåï¼‰
        function updateChatHistoryAfterRegenerate(fromIndex) {
            if (!currentChatId) return;
            
            const chat = chatHistory.find(c => c.id === currentChatId);
            if (chat) {
                // æˆªæ–­åˆ°æŒ‡å®šç´¢å¼•
                chat.messages = chat.messages.slice(0, fromIndex);
                
                // ä¿å­˜åˆ°localStorage
                const historyKey = getUserChatHistoryKey();
                localStorage.setItem(historyKey, JSON.stringify(chatHistory));
            }
        }
        
        // ä¿å­˜é‡æ–°ç”Ÿæˆçš„æ¶ˆæ¯
        function saveRegeneratedMessage(userMessage, aiResponse) {
            if (!currentChatId) return;
            
            const chat = chatHistory.find(c => c.id === currentChatId);
            if (chat) {
                // æ·»åŠ AIå›å¤
                chat.messages.push({ role: 'assistant', content: aiResponse });
                
                // æ›´æ–°æ€»ç»“
                chat.summary = generateChatSummary(chat.messages);
                
                // ä¿å­˜åˆ°localStorage
                const historyKey = getUserChatHistoryKey();
                localStorage.setItem(historyKey, JSON.stringify(chatHistory));
            }
        }

    </script>
</body>
</html>